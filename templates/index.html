<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>慰霊地マッピングサイト</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <!-- PDF export libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* Reset and basic styles */
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; font-family: 'Helvetica Neue', Arial, sans-serif; }
        
        /* Layout */
        .container { display: flex; flex-direction: column; height: 100%; }
        
        /* Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background-color: #fff;
            border-bottom: 1px solid #ddd;
            flex-shrink: 0;
        }
        header h1 { margin: 0; font-size: 1.5em; }
        
        /* PDF Button */
        .pdf-button {
            padding: 8px 16px;
            background-color: #4A90E2;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s;
        }
        .pdf-button:hover { background-color: #357ABD; }
        
        /* Map container */
        #map { flex-grow: 1; background-color: #eee; }
        
        /* Info Panel */
        .info-panel {
            position: fixed;
            right: -100%; /* Initially hidden */
            top: 0;
            width: 350px;
            height: 100%;
            background-color: white;
            box-shadow: -2px 0 5px rgba(0,0,0,0.1);
            transition: right 0.4s ease-in-out;
            z-index: 1000;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        .info-panel.active { right: 0; }
        
        .info-panel h2 {
            margin: 0;
            padding: 20px;
            font-size: 1.2em;
            background-color: #f7f7f7;
            border-bottom: 1px solid #ddd;
        }
        
        .info-content { padding: 20px; }
        .info-content p { margin: 0 0 15px; line-height: 1.6; }
        .info-content strong { color: #333; }
        .info-content a { color: #4A90E2; text-decoration: none; }
        .info-content a:hover { text-decoration: underline; }
        
        /* Close button for panel */
        .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 2em;
            font-weight: bold;
            color: #aaa;
            background: none;
            border: none;
            cursor: pointer;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            font-size: 1.2em;
            color: #333;
        }

        /* Responsive */
        @media (max-width: 600px) {
            .info-panel { width: 100%; }
            header h1 { font-size: 1.2em; }
        }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>慰霊地マップ</h1>
            <button id="pdf-download" class="pdf-button">PDFで保存</button>
        </header>
        <div id="map"></div>
    </div>

    <div id="info-panel" class="info-panel">
        <button id="close-panel" class="close-btn">&times;</button>
        <h2><span id="info-name">場所の名前</span></h2>
        <div class="info-content">
            <p><strong>都道府県:</strong> <span id="info-prefecture">---</span></p>
            <p><strong>取材記事:</strong> <a id="info-article" href="#" target="_blank" rel="noopener noreferrer"></a></p>
            <p><strong>誕生日/開設日など:</strong> <span id="info-date">---</span></p>
            <p><strong>アクセス:</strong> <span id="info-access">---</span></p>
            <p><strong>住所:</strong> <span id="info-address">---</span></p>
        </div>
    </div>

    <div id="loading" class="loading-overlay" style="display: none;">
        <p>地図データを読み込んでいます...</p>
    </div>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <script>
        // --- 設定 ---
        // !!! 要設定 !!! GASをデプロイした際に取得したウェブアプリのURLに書き換えてください
        const gasWebAppUrl = 'https://script.google.com/macros/s/AKfycbya3uc7FnDYxXxj4CGB6qChpyecMN2e60Z_OkfklETvyX2Unig4lCR0y-_AF4rDJfx8/exec';

        // --- DOM要素の取得 ---
        const mapElement = document.getElementById('map');
        const infoPanel = document.getElementById('info-panel');
        const closePanelBtn = document.getElementById('close-panel');
        const pdfDownloadBtn = document.getElementById('pdf-download');
        const loadingOverlay = document.getElementById('loading');
        
        let map; // マップオブジェクトをグローバルに保持

        /**
         * GASから地図データを非同期で読み込む
         */
        async function loadMapData() {
            if (gasWebAppUrl === 'YOUR_GAS_WEB_APP_URL' || gasWebAppUrl === '') {
                alert('GASのウェブアプリURLが設定されていません。scriptタグ内の「gasWebAppUrl」を修正してください。');
                return;
            }
            loadingOverlay.style.display = 'flex';
            try {
                const response = await fetch(gasWebAppUrl);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const result = await response.json();
                if (result.status === 'success' && result.data) {
                    initMap(result.data);
                } else {
                    throw new Error('APIから有効なデータが取得できませんでした: ' + (result.message || '不明なエラー'));
                }
            } catch (error) {
                console.error("データの読み込みに失敗しました:", error);
                alert("データの読み込みに失敗しました。コンソールを確認してください。");
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }

        /**
         * 地図を初期化し、マーカーを配置する
         * @param {Array} locations - GASから取得した場所データの配列
         */
        function initMap(locations) {
            map = L.map(mapElement).setView([35.681236, 139.767125], 5); // 初期表示: 東京駅あたり
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            locations.forEach(location => {
                const lat = parseFloat(location.lat);
                const lng = parseFloat(location.lng);

                if (isNaN(lat) || isNaN(lng)) {
                    console.warn(`無効な座標のためスキップ: ${location.name}`);
                    return; // 座標が無効なデータはスキップ
                }

                const marker = L.marker([lat, lng]).addTo(map);
                
                // --- ★修正箇所★ ---
                // ピンがクリックされた時の動作を定義
                marker.on('click', () => {
                    // 各情報をパネルに設定
                    document.getElementById('info-name').textContent = location.name || '---';
                    document.getElementById('info-prefecture').textContent = location.prefecture || '---';
                    document.getElementById('info-date').textContent = location.date || '---';
                    document.getElementById('info-access').textContent = location.access || '---';
                    document.getElementById('info-address').textContent = location.address || '---';

                    // 取材記事のリンクを処理
                    const articleLink = document.getElementById('info-article');
                    const articleParagraph = articleLink.parentElement; // <p>タグを取得

                    // articleUrlが存在し、空文字でないことを確認
                    if (location.articleUrl && String(location.articleUrl).trim() !== '') {
                        articleLink.href = location.articleUrl; // リンク先URLを設定
                        articleLink.textContent = '記事を読む';  // 表示テキストを設定
                        articleParagraph.style.display = '';    // <p>要素を表示状態に戻す
                    } else {
                        // URLがない場合は行全体を非表示にする
                        articleLink.textContent = '';
                        articleParagraph.style.display = 'none';
                    }
                    
                    // パネルを表示
                    infoPanel.classList.add('active');
                });
            });
        }

        /**
         * 地図をPDFとしてダウンロードする
         */
        async function downloadMapAsPDF() {
            const loadingText = pdfDownloadBtn.textContent;
            pdfDownloadBtn.textContent = '生成中...';
            pdfDownloadBtn.disabled = true;

            try {
                // Leafletのクレジットを一時的に表示（キャプチャに含めるため）
                document.querySelector('.leaflet-control-container').style.display = 'block';

                const canvas = await html2canvas(mapElement, {
                    useCORS: true,
                    logging: false,
                    onclone: (doc) => {
                        // クローンされたDOMでマーカーが正しく表示されるように調整
                        const markers = doc.querySelectorAll('.leaflet-marker-icon');
                        markers.forEach(marker => {
                           marker.style.marginTop = (-marker.offsetHeight) + 'px';
                        });
                    }
                });

                const imgData = canvas.toDataURL('image/png');
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: canvas.width > canvas.height ? 'l' : 'p',
                    unit: 'px',
                    format: [canvas.width, canvas.height]
                });
                pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
                pdf.save('慰霊地マップ.pdf');
            } catch (error) {
                console.error('PDFの生成に失敗しました:', error);
                alert('PDFの生成に失敗しました。');
            } finally {
                pdfDownloadBtn.textContent = loadingText;
                pdfDownloadBtn.disabled = false;
            }
        }

        // --- イベントリスナー ---
        closePanelBtn.addEventListener('click', () => infoPanel.classList.remove('active'));
        mapElement.addEventListener('click', (e) => {
            // マップ自体がクリックされたらパネルを閉じる（マーカークリックと競合しないように）
             if (e.target.id === 'map') {
                infoPanel.classList.remove('active');
             }
        });
        pdfDownloadBtn.addEventListener('click', downloadMapAsPDF);
        
        // --- 初期読み込み ---
        document.addEventListener('DOMContentLoaded', loadMapData);
    </script>
</body>
</html>

